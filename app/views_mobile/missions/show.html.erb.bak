<script id="headerTmpl" type="text/html">
<a href="#" data-rel="back" data-bind="visible: showBack">Back</a>
<h1>King Co. SAR</h1>
<a href="#" data-icon="bars" class="ui-btn-right">Menu</a>
</script>

<div id="frontPage" data-role="page">
<div data-role="header" data-bind="template: { name: 'headerTmpl' }" data-position="fixed"></div>
<div data-role="content">
  <p data-bind="text:app.mission().title"></p>
  <a href="#signinPage" data-role="button" class="ui-disabled">Sign In</a>
<span data-bind="text: app.noBriefing"></span>
  <ul data-role="listview" data-inset="true">
    <li><a href="#briefingPage" data-bind="jqmButtonEnabled: app.hasBriefing">Briefing</a></li>
    <li><a href="#rosterPage" class="ui-disabled">Roster</a></li>
    <li><a href="#logsPage">Mission Log</a></li>
  </ul>
</div>
</div>
<!-- ======================  -->
<div id="signinPage" data-role="page" data-add-back-btn="true" >
<div data-role="header" data-bind="template: { name: 'headerTmpl' }" data-position="fixed"></div>
<div data-role="content">
	Sign in page
</div>
</div>
<!-- ======================  -->
<div id="briefingPage" data-role="page" data-title="Mission Briefing">
<div data-role="header" data-bind="template: { name: 'headerTmpl' }" data-position="fixed"></div>
<div data-role="content">
</div>
</div>
<!-- ======================  -->
<div id="rosterPage" data-role="page" data-title="Mission Roster">
<div data-role="header" data-bind="template: { name: 'headerTmpl' }" data-position="fixed"></div>
<div data-role="content">
My content
</div>
</div>
<!-- ======================  -->
<div id="logsPage" data-role="page" data-title="Mission Log">
<div data-role="header" data-bind="template: { name: 'headerTmpl' }" data-position="fixed"></div>
<div data-role="content" style="padding-left:5px; padding-top:5px;">
<h3 style="margin-top:0px;">Mission Log</h3>
  <ul data-role="listview" data-bind="foreach: app.logs, listViewRefresh: app.logs">
    <li><a href="#logDetailPage" data-rel="dialog" data-bind="click:$parent.selectLog"><span style="font-weight:bold;" data-bind="text: $parent.getDateOffset(when) + when.toString('HH:mm')"></span> <span data-bind="text:message"></span></a></li>
  </ul>
</div>
</div>
<!-- ======================  -->
<div id="logDetailPage" data-role="page">
<div data-role="header"><h3>Mission Log</h3></div>
<div data-role="content">
<h3 style="margin-top:0" data-bind="text:selected().when.toString('HH:mm ddd MMM d')"></h3>
<p data-bind="text:selected().message"></p>
</div>
</div>

<script type="text/javascript" src="http://<%= request.host %>:9292/faye.js"></script>
<script type="text/javascript">

var FrontPageModel = function(appModel) {
  this.app = appModel;
	this.showBack = false;
}

var SigninPageModel = function(appModel) {
  this.app = appModel;
	this.showBack = true;
}

var LogsPageModel = function(appModel) {
  var self = this;
  this.app = appModel;
  this.showBack = true;
  this.selected = ko.observable();
  this.selectLog = function(a)
  {
    self.selected(a);
		return true;
  }

  this.getDateOffset = function(t)
  {
    if (self.app && self.app.mission() && self.app.mission().started)
    {
      var d = self.app.mission().started;
      d.clearTime();
      var t2 = t.clone().clearTime();

      var diff = d.diffDays(t2);
      return diff ? diff + '+' : '';
    }
    return t.toString('MMM dd ');
  }
}

var AppModel = function(mission)
{
  mission.started = new XDate(mission.started);
  var self = this;
  this.mission = ko.observable(mission);
  this.briefingText = ko.observable('');
  this.logs = ko.observableArray();
  this.loadingLogs = ko.observable(false);

  this.toastLogs = ko.observable(true);

  this.hasBriefing = ko.computed(function() { return this.briefingText() != ''; }, this);

  this.loadLogs = function()
  {
    self.loadingLogs(true);
    $.ajax({type:'GET', url: siteRoot+'missions/' + self.mission().id + '/logs.json' })
     .done(function(result) {
       for (var i=0; i<result.length; i++) result[i].when = new XDate(result[i].when);
       self.logs(result);
       self.loadingLogs(false);
     });
  }
  this.pushLog = function(apiLog)
  { 
    apiLog.when = new XDate(apiLog.when);
    if (apiLog.mission_id != self.mission().id) return;
log(apiLog.message);                
    self.logs.push(apiLog);
    self.logs.sort(self.logsSort);
    if (self.toastLogs() && apiLog.when.getTime() + 300000 > new Date().getTime()) $.mobile.showToast(apiLog.message);
  }
  this.logsSort = function(left, right)
  {
    var l = isNaN(left.when) ? new Date(0) : left.when.getTime();
    var r = isNaN(right.when) ? new Date(0) : right.when.getTime();
    var val = 0;

    val = (l == r) ? (left.id < right.id ? 1 : -1) : (l < r ? 1 : -1);

    return val;
  }

}

var appModel = new AppModel({});
var models = { };

$('[data-role="page"]').on('pagecreate', function(a) {
log('create page ' + a.target.id);
  var model = models[a.target.id];
  if (model) { ko.applyBindings(model, a.target); }
 });

var faye = null;
$(document).ready(function() {
  faye = new Faye.Client(fayeRoot);
  faye.subscribe("/logs/new", function(data) {
    data = JSON.parse(data)
    appModel.pushLog(data);
  });
  faye.subscribe("/logs/delete", function(data) {
    appModel.logs.remove(function(f) { return f.id == data });
  });

  setTimeout(function() {
    appModel.loadLogs();
  }, 1000);
});
</script>


<script type="text/javascript">
appModel = new AppModel(<%= @mission.to_json.html_safe %>);

models = {
  frontPage: new FrontPageModel(appModel),
  signinPage: new SigninPageModel(appModel),
  logsPage: new LogsPageModel(appModel)
 };
models.logDetailPage = models.logsPage;
</script>
